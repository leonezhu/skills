---
name: daily-plan
description: 智能生成每日计划，根据周计划和前一天完成情况动态调整任务
---

# Daily Plan Skill

## 功能
根据以下信息生成每日计划：
1. **周计划** - `/Daily/{年}-W{周号}.md` 或 `/Daily/{周一开始日期}.md`
2. **前一天日志** - 分析完成状态
3. **Daily Plan** - 每日固定任务和每周重复任务
4. **每日模板** - `/Templates/Daily Note Template.md`

## 使用方法

### 基本命令
```
"生成今天的每日计划"
"创建 2025-12-28 的日计划"
"基于周计划生成今日任务"
```

### 工作流程
```
周计划 + 昨天日志 + Daily Plan → 生成今日计划
```

## 任务处理规则

### 1. 昨日状态分析（关键！）

**必须正确识别已完成任务，避免重复：**

昨天日志可能的格式：
```markdown
- [x] 完成年度总结报告 ✅ 2025-12-28
- [x] **完成项目 A 的设计文档 - ❌ 未完成** - 🔴 优先（昨日未完成（时间不足）） ✅ 2025-12-28
- [x] **运动 30 分钟 - 进行中** - 🟡 昨日 50% ✅ 2025-12-28
- [ ] 保养摩托车
- [x] **去健身房锻炼** - 📅 本周第 1/3 次 ✅ 2025-12-28
```

**识别规则：**
- ✅ **已完成**：`- [x]` 开头的任务（即使有日期标记）→ 跳过
- 🔄 **进行中**：包含 `🔄` 或 `进行中` → 今日中优先级 🟡
- ❌ **未完成**：包含 `❌` 或 `未完成` → 今日高优先级 🔴
- ⏸️ **未开始**：`- [ ]` 开头且无特殊标记 → 继续处理

**关键：清理任务名称时必须移除：**
- `[x]` 标记
- `✅` `🔄` `❌` `🔴` `🟡` `⚪` 等符号
- 括号内容 `()` `（）`
- `**` 加粗标记
- **日期标记** `✅ 2025-12-28` ← 这个容易被忽略！

### 2. 周计划任务
- **普通任务** → 低优先级 ⚪
- **每周重复**（含"每周/一周/次/周"）→ 中优先级 📅，自动统计本周执行次数

### 3. Daily Plan 任务
- **每日固定** → 自动添加到每天
- **每周重复** → 智能分配（如"去健身房锻炼（一周 3 次）"）

### 4. 智能计数逻辑（关键！）

**问题：** 如何正确显示 "本周第 X/3 次"？

**示例场景：**
```
Daily Plan: 去健身房锻炼（一周 3 次）
2025-12-27: [x] **去健身房锻炼** - 📅 本周第 1/3 次 ✅ 2025-12-28
2025-12-28: 应该显示 → [ ] **去健身房锻炼** - 📅 本周第 2/3 次
```

**AI 需要实现的逻辑：**

1. **统计本周已完成次数：**
   - 扫描本周所有 daily 文件
   - 找到任务名匹配且标记为 `[x]` 的行
   - 提取其中的数字（如 "第 1/3 次" → count = 1）

2. **计算今日显示：**
   ```
   已完成次数 = 1
   今日显示 = 第 (1+1)/3 次 = 第 2/3 次
   ```

3. **判断是否需要添加到今日：**
   ```
   if 已完成次数 < 总次数:
       添加到今日计划
       显示 = 第 (已完成次数+1)/总次数 次
   else:
       本周已完成，跳过
   ```

**实现方式：**
- Python 脚本：需要增强 `count_weekly_executions` 函数
- **AI Agent：** 读取本周所有日志，智能计算并生成正确格式

## 文件结构

### 输入
- `/Daily/2025-W52.md` - 周计划
- `/Daily/2025-12-26.md` - 昨天日志
- `/Daily/Daily Plan.md` - 每日固定任务
- `/Templates/Daily Note Template.md` - 模板

### 输出
- `/Daily/2025-12-27.md` - 今日计划

## 示例

### 周计划
```markdown
## 本周任务
- [ ] 完成年度总结报告
- [ ] 保养摩托车
- [ ] 读《深度学习》第1-3章并写3篇笔记（分配：每天1章+1笔记）
```

### Daily Plan
```markdown
- [ ] 去健身房锻炼（一周 3 次）
- [ ] 英语口语练习（10min）
```

### 昨天日志
```markdown
## 今日任务
- [x] 完成年度总结报告 ✅
- [ ] 保养摩托车 🔄 50%
- [ ] 完成项目设计 ❌ 原因：时间不足
```

### 生成的今日计划
```markdown
## ✅ 今日任务
- [ ] **完成项目设计** - 🔴 优先（昨日未完成（时间不足））
- [ ] **保养摩托车** - 🟡 昨日 50%
- [ ] 完成年度总结报告
- [ ] 去健身房锻炼 - 📅 本周第 1/3 次
- [ ] 英语口语练习（10min）
```

## 智能任务分配

对于复杂任务（如"读《书名》第1-3章并写3篇笔记"），**不要**在 Python 中硬编码拆分逻辑。

**正确做法：**
1. 在周计划中明确描述任务结构
2. AI 助手根据描述智能分配到每天
3. 用户只需运行 `openskills read daily-plan`

详见：`智能任务分配指南.md`

## AI 必须实现的逻辑（核心！）

### 场景分析：2025-12-28 的生成过程

**已知信息：**
- 昨天（12-27）的日志：已完成 8 个任务，未完成 2 个（保养摩托车、Anki 复习）
- Daily Plan：7 个每日固定任务 + 1 个每周重复（健身房 3 次/周）
- 周计划：3 个任务（年度报告、保养摩托车、读书笔记）

**AI 必须执行的逻辑：**

#### 1. 分析昨日完成情况
```python
昨日已完成 = [
    "完成年度总结报告",
    "读《深度学习》第1-3章并写3篇笔记",
    "Duolingo 每日打卡",
    "TalkAI 单词记忆最少 6 个",
    "英语口语练习",
    "技术资讯了解",
    "去健身房锻炼",  # 注意：这个任务完成了，但需要提取执行次数
    "书籍阅读"
]

昨日未完成 = ["保养摩托车", "Anki 复习"]

昨日进行中 = ["完成项目 A 的设计文档", "运动 30 分钟"]
```

#### 2. 处理每周重复任务（关键！）
```python
# 从昨日日志中提取：- [x] **去健身房锻炼** - 📅 本周第 1/3 次
# 提取数字：已完成次数 = 1
# 今日计算：第 (1+1)/3 次 = 第 2/3 次

if 已完成次数 < 总次数:
    添加到今日计划
    显示 = f"本周第 {已完成次数+1}/{总次数} 次"
```

#### 3. 生成今日任务（正确顺序）
```python
今日任务 = []

# 1. 昨日未完成（高优先级 🔴）→ 但昨天已经标记为 [x] 了，所以跳过
# 2. 昨日进行中（中优先级 🟡）→ 继续
今日任务.append("**完成项目 A 的设计文档 - ❌ 未完成** - 🔴 优先（昨日未完成（时间不足））")
今日任务.append("**运动 30 分钟 - 进行中** - 🟡 昨日 50%")

# 3. 周计划中未完成的任务
#    - 完成年度总结报告 ✅ 已完成，跳过
#    - 保养摩托车 ⏸️ 未完成，继续
今日任务.append("保养摩托车")

# 4. Daily Plan 中的每日固定任务
#    - 已完成的：Duolingo, TalkAI, 英语, 技术, 书籍 → 跳过
#    - 未完成的：Anki 复习 → 继续
今日任务.append("Anki 复习（复习 5 个卡片）")

# 5. Daily Plan 中的每周重复任务
#    - 去健身房锻炼：已完成 1 次，今日第 2 次
今日任务.append("**去健身房锻炼** - 📅 本周第 2/3 次")

# 6. 其他每日固定任务（今天未完成的）
今日任务.append("Duolingo 每日打卡 （1min）")
今日任务.append("TalkAI 单词记忆最少 6 个（10min）")
今日任务.append("英语口语练习（10min）")
今日任务.append("技术资讯了解（10min）")
今日任务.append("书籍阅读（10min）")
```

**最终结果（10 个任务）：**
```
- [ ] **完成项目 A 的设计文档 - ❌ 未完成** - 🔴 优先（昨日未完成（时间不足））
- [ ] **运动 30 分钟 - 进行中** - 🟡 昨日 50%
- [ ] 保养摩托车
- [ ] Anki 复习（复习 5 个卡片）
- [ ] **去健身房锻炼** - 📅 本周第 2/3 次
- [ ] Duolingo 每日打卡 （1min）
- [ ] TalkAI 单词记忆最少 6 个（10min）
- [ ] 英语口语练习（10min）
- [ ] 技术资讯了解（10min）
- [ ] 书籍阅读（10min）
```

---

## AI 实现指南（Agent 模式）

### 完整的每日计划生成流程

当用户说"生成今日计划"时，AI 应该：

#### 步骤 1: 读取并分析所有相关文件
```python
# 1. 读取周计划
周计划 = read("Daily/2025-W52.md")
# 2. 读取昨天日志
昨天 = read("Daily/2025-12-27.md")
# 3. 读取 Daily Plan
daily_plan = read("Daily/Daily Plan.md")
# 4. 扫描本周所有日志（用于计数）
本周日志 = glob("Daily/2025-12-*.md")
```

#### 步骤 2: 识别昨日任务状态
```python
已完成 = []
进行中 = []
未完成 = []

for line in 昨天日志:
    if "- [x]" in line:
        # 提取任务名，移除所有标记
        task_name = clean_task(line)  # 移除 [x], ✅, 🔴, 🟡, 括号, 加粗, 日期等
        已完成.append(task_name)
    elif "🔄" in line or "进行中" in line:
        进行中.append(task_name)
    elif "❌" in line or "未完成" in line:
        未完成.append(task_name)
```

#### 步骤 3: 处理每周重复任务（关键！）
```python
# 对于 Daily Plan 中的 "去健身房锻炼（一周 3 次）"
任务名 = "去健身房锻炼"
总次数 = 3

# 统计本周已完成次数
已完成次数 = 0
for 日志文件 in 本周日志:
    内容 = read(日志文件)
    for line in 内容:
        if 任务名 in line and "- [x]" in line:
            # 提取 "第 X/3 次" 中的 X
            match = re.search(r'第\s*(\d+)/(\d+)\s*次', line)
            if match:
                已完成次数 = int(match.group(1))
                break

# 计算今日应该显示
if 已完成次数 < 总次数:
    今日次数 = 已完成次数 + 1
    添加到今日计划(任务名, f"本周第 {今日次数}/{总次数} 次")
```

#### 步骤 4: 生成今日任务列表
```python
今日任务 = []

# 1. 未完成任务（高优先级 🔴）
for task in 未完成:
    今日任务.append(f"- [ ] **{task}** - 🔴 优先（昨日未完成）")

# 2. 进行中任务（中优先级 🟡）
for task in 进行中:
    今日任务.append(f"- [ ] **{task}** - 🟡 昨日 50%")

# 3. 周计划任务（排除已完成）
for task in 周计划任务:
    if task not in 已完成 and task not in [t['name'] for t in 今日任务]:
        今日任务.append(f"- [ ] {task}")

# 4. Daily Plan 任务（包括每周重复）
# 见步骤 3 的逻辑
```

#### 步骤 5: 应用模板并保存
```python
模板 = read("Templates/Daily Note Template.md")
内容 = 应用模板(模板, 今日任务)
保存到("Daily/2025-12-28.md", 内容)
```

### 关键函数实现

#### clean_task 函数
```python
def clean_task(line):
    """清理任务行，返回纯任务名"""
    # 移除 [x] 标记
    line = re.sub(r'-\s*\[\s*[xX]?\s*\]', '', line)
    # 移除特殊符号
    line = re.sub(r'[✅🔄🔴🟡⚪]', '', line)
    # 移除括号内容
    line = re.sub(r'\([^)]*\)|（[^）]*）', '', line)
    # 移除加粗
    line = re.sub(r'\*\*', '', line)
    # 移除日期标记（关键！）
    line = re.sub(r'✅\s*\d{4}-\d{2}-\d{2}', '', line)
    # 移除多余空格
    line = re.sub(r'\s+', ' ', line).strip()
    return line
```

#### 统计每周执行次数
```python
def count_weekly_executions(task_name, week_start, week_end):
    """统计任务在本周的执行次数"""
    count = 0
    for date in 本周日期范围:
        日志文件 = f"Daily/{date}.md"
        if not exists(日志文件):
            continue
        内容 = read(日志文件)
        for line in 内容:
            if task_name in line and "- [x]" in line:
                count += 1
                break
    return count
```

### 常见问题修复

#### 问题 1: 已完成任务在第二天重复出现

**原因：** `clean_task` 没有移除日期标记 `✅ 2025-12-28`

**修复：** 使用上面的 `clean_task` 函数，包含日期标记清理

#### 问题 2: 每周重复任务计数错误

**原因：** 没有正确提取历史日志中的 "第 X/3 次" 信息

**修复：**
1. 扫描本周所有日志
2. 找到已完成的任务
3. 提取其中的数字 X
4. 今日显示 = 第 (X+1)/总次数 次

#### 问题 3: Python 脚本维护困难

**解决方案：** 使用 AI Agent 模式
- AI 理解所有规则
- 智能处理各种格式变体
- 无需修改 Python 代码

## 最佳实践

### ✅ 推荐
1. **周计划** - 任务描述具体化
2. **Daily Plan** - 使用"一周 X 次"标记重复任务
3. **每日日志** - 及时更新完成状态
4. **工作流程** - 每天早上运行技能生成计划
5. **格式一致性** - 保持任务标记格式统一

### ❌ 避免
1. 手动分配复杂任务（让 AI 做）
2. 忽略任务完成状态更新
3. 跨周任务（拆分到每周）
4. 混合多种任务标记格式

---

**注意：** 通过 `Bash("openskills read daily-plan")` 调用